#!/usr/bin/env ruby
# frozen_string_literal: true

require "bundler/setup"
require "dotenv/load"

$LOAD_PATH.unshift(File.expand_path("../lib", __dir__))
require "eodhd"

begin
	cfg = Eodhd::Config.eodhd!
rescue Eodhd::Config::Error => e
	abort e.message
end

api = Eodhd::Api.new(
  base_url: cfg.base_url,
  api_token: cfg.api_token
)

io = Eodhd::Io.new(output_dir: cfg.output_dir)

exchanges_json = api.get_exchanges_list_json!
exchanges_path = io.save_exchanges_list_json!(json: exchanges_json)
puts "Wrote #{exchanges_path}"

# First iteration: hardcoded exchange code
exchange_code = "US"
symbols_json = api.get_exchange_symbol_list_json!(exchange_code: exchange_code)
symbols_path = io.save_exchange_symbol_list_json!(exchange_code: exchange_code, json: symbols_json)
puts "Wrote #{symbols_path}"

csv = api.fetch_mcd_csv!

output_path = io.save_mcd_csv!(csv: csv)
puts "Wrote #{output_path}"
