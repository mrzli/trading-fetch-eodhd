#!/usr/bin/env ruby
# frozen_string_literal: true

require "parallel"

def expensive_work(arg)
  sleep rand(0.1..1.5)   # simulate work
  arg * 2
end

items = (1..20).to_a
mode = (ARGV[0] || "processes").to_s.strip

puts "Running mode: #{mode}"

case mode
when "processes"
  # 1. in_processes = true parallelism (recommended for CPU work)
  results = Parallel.map(items, in_processes: 4) do |i|
    value = expensive_work(i)
    puts "process #{Process.pid}: #{i} -> #{value}"
    value
  end
  puts "Results count: #{results.size}"
when "threads"
  # 2. in_threads = good for I/O bound work
  results = Parallel.map(items, in_threads: 8) do |i|
    value = expensive_work(i)
    puts "thread #{Thread.current.object_id}: #{i} -> #{value}"
    value
  end
  puts "Results count: #{results.size}"
when "each"
  # 3. each (no collection of results)
  Parallel.each(items, in_processes: 4) do |i|
    value = expensive_work(i)
    puts "process #{Process.pid}: #{i} -> #{value}"
    # no return value collected
  end
else
  warn "Unknown mode: #{mode}. Use: processes | threads | each"
  exit 1
end
