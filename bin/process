#!/usr/bin/env ruby
# frozen_string_literal: true

require "bundler/setup"
require "dotenv/load"
require "optparse"

$LOAD_PATH.unshift(File.expand_path("../lib", __dir__))
require "eodhd"

mode = "eod"
exchange_filters = []
symbol_filters = []

parser = OptionParser.new do |opts|
	opts.banner = "Usage: bin/process [options]"

	opts.on("-mMODE", "--mode=MODE", "Mode: eod or intraday (default: eod)") do |v|
		mode = v.to_s.strip
	end

	opts.on("-eFILTER", "--exchange-filter=FILTER", "Exchange substring filter (repeatable or comma-separated)") do |v|
		exchange_filters.concat(v.to_s.split(",").map(&:strip))
	end

	opts.on("-sFILTER", "--symbol-filter=FILTER", "Symbol substring filter (repeatable or comma-separated)") do |v|
		symbol_filters.concat(v.to_s.split(",").map(&:strip))
	end

	opts.on("-h", "--help", "Show this help") do
		puts opts
		exit 0
	end
end

begin
	parser.parse!(ARGV)
rescue OptionParser::ParseError => e
	warn e.message
	warn parser
	exit 2
end

unless ARGV.empty?
	warn "Unexpected arguments: #{ARGV.join(" ")}."
	warn parser
	exit 2
end

mode = mode.to_s.strip.downcase
unless %w[eod intraday].include?(mode)
	warn "Unknown mode: #{mode.inspect}. Expected 'eod' or 'intraday'."
	warn parser
	exit 2
end

Eodhd::Process.run(
	mode: mode,
	exchange_filters: exchange_filters,
	symbol_filters: symbol_filters
)
